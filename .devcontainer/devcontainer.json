{
  "name": "Secure MPC Transformer Development",
  "build": {
    "dockerfile": "Dockerfile",
    "context": "..",
    "args": {
      "VARIANT": "3.10-bullseye",
      "CUDA_VERSION": "12.0"
    }
  },
  
  "settings": {
    "python.defaultInterpreterPath": "/opt/conda/bin/python",
    "python.linting.enabled": true,
    "python.linting.pylintEnabled": true,
    "python.linting.flake8Enabled": true,
    "python.linting.mypyEnabled": true,
    "python.linting.banditEnabled": true,
    "python.formatting.provider": "black",
    "python.formatting.blackArgs": ["--line-length=88"],
    "python.sortImports.args": ["--profile", "black"],
    "python.testing.pytestEnabled": true,
    "python.testing.pytestArgs": ["tests/"],
    "editor.formatOnSave": true,
    "editor.codeActionsOnSave": {
      "source.organizeImports": true
    },
    "terminal.integrated.shell.linux": "/bin/bash",
    "git.enableCommitSigning": true
  },

  "extensions": [
    "ms-python.python",
    "ms-python.vscode-pylance",
    "ms-python.black-formatter",
    "ms-python.isort",
    "ms-python.pylint",
    "ms-python.mypy-type-checker",
    "ms-vscode.vscode-typescript-next",
    "ms-vscode.cmake-tools",
    "ms-vscode.cpptools",
    "nvidia.nsight-vscode-edition",
    "redhat.vscode-yaml",
    "ms-vscode.vscode-json",
    "timonwong.shellcheck",
    "foxundermoon.shell-format",
    "ms-azuretools.vscode-docker",
    "ms-kubernetes-tools.vscode-kubernetes-tools",
    "github.copilot",
    "github.copilot-chat",
    "github.vscode-pull-request-github",
    "eamodio.gitlens",
    "davidanson.vscode-markdownlint",
    "yzhang.markdown-all-in-one",
    "streetsidesoftware.code-spell-checker",
    "ms-vsliveshare.vsliveshare",
    "redhat.vscode-xml",
    "tamasfe.even-better-toml"
  ],

  "forwardPorts": [
    8080, 8001, 8002, 8003, 9090, 3000, 6379, 5432, 8888, 6006
  ],

  "portsAttributes": {
    "8080": {
      "label": "API Server",
      "onAutoForward": "notify"
    },
    "9090": {
      "label": "Prometheus",
      "onAutoForward": "silent"
    },
    "3000": {
      "label": "Grafana",
      "onAutoForward": "silent"
    },
    "8888": {
      "label": "Jupyter",
      "onAutoForward": "openPreview"
    }
  },

  "runArgs": [
    "--gpus=all",
    "--shm-size=2g",
    "--ulimit", "memlock=-1",
    "--ulimit", "stack=67108864",
    "--network=host"
  ],

  "containerEnv": {
    "NVIDIA_VISIBLE_DEVICES": "all",
    "NVIDIA_DRIVER_CAPABILITIES": "compute,utility",
    "CUDA_VISIBLE_DEVICES": "all",
    "MPC_ENVIRONMENT": "development",
    "MPC_DEBUG": "true",
    "MPC_LOG_LEVEL": "DEBUG",
    "PYTHONPATH": "/workspace/src",
    "PATH": "/opt/conda/bin:/usr/local/cuda/bin:${PATH}",
    "LD_LIBRARY_PATH": "/usr/local/cuda/lib64:${LD_LIBRARY_PATH}"
  },

  "postCreateCommand": "bash .devcontainer/post-create.sh",
  "initializeCommand": "bash .devcontainer/initialize.sh",
  "onCreateCommand": "bash .devcontainer/on-create.sh",
  "updateContentCommand": "bash .devcontainer/update-content.sh",
  "postStartCommand": "bash .devcontainer/post-start.sh",

  "remoteUser": "vscode",
  "userEnvProbe": "loginInteractiveShell",

  "mounts": [
    "source=secure-mpc-node-modules,target=\${containerWorkspaceFolder}/node_modules,type=volume",
    "source=secure-mpc-conda-pkgs,target=/opt/conda/pkgs,type=volume",
    "source=secure-mpc-pip-cache,target=/home/vscode/.cache/pip,type=volume",
    "source=secure-mpc-models,target=/workspace/models,type=volume",
    "source=secure-mpc-data,target=/workspace/data,type=volume"
  ],

  "workspaceFolder": "/workspace",
  "workspaceMount": "source=\${localWorkspaceFolder},target=/workspace,type=bind,consistency=cached",

  "features": {
    "ghcr.io/devcontainers/features/git:1": {
      "ppa": true,
      "version": "latest"
    },
    "ghcr.io/devcontainers/features/github-cli:1": {
      "version": "latest"
    },
    "ghcr.io/devcontainers/features/docker-in-docker:2": {
      "version": "latest",
      "enableNonRootDocker": "true"
    },
    "ghcr.io/devcontainers/features/kubectl-helm-minikube:1": {
      "version": "latest",
      "helm": "latest",
      "minikube": "none"
    }
  }
}
